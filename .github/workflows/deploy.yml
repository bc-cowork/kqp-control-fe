name: Build and Deploy Next.js

on:
  push:
    branches: [main]
    # If you later re-enable "commit tar" behavior, keep the ignore here.
    paths-ignore:
      - "kqp-control-fe-offline-npm.tar.gz"

permissions:
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      NEXT_PUBLIC_SERVER_URL: ${{ secrets.NEXT_PUBLIC_SERVER_URL }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node 20.12.2
        uses: actions/setup-node@v4
        with:
          node-version: "20.12.2"
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Install dependencies (npm, legacy peer deps)
        run: npm install --legacy-peer-deps

      - name: Build Next.js app
        env:
          NEXT_TELEMETRY_DISABLED: "1"
        run: |
          npx --yes next telemetry disable || true
          npm run build
          test -d .next || (echo ".next not found after build" && exit 1)

      - name: Deploy to server (rsync + pm2, npm on server)
        env:
          DEPLOY_SERVER: ${{ secrets.DEPLOY_SERVER }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }} # private key contents
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }} # e.g. /var/www/kqp-control-fe
        run: |
          set -euo pipefail
          echo "$DEPLOY_KEY" > deploy_key
          chmod 600 deploy_key

          # Sync only what the server needs to run: build output + runtime files
          rsync -avz --delete -e "ssh -i deploy_key -o StrictHostKeyChecking=no" \
            .next package.json package-lock.json public \
            "$DEPLOY_USER@$DEPLOY_SERVER:$DEPLOY_PATH/"

          # On the server: install production deps (legacy peers), start/restart with pm2
          ssh -i deploy_key -o StrictHostKeyChecking=no "$DEPLOY_USER@$DEPLOY_SERVER" "
            set -e
            cd '$DEPLOY_PATH'
            npm install --omit=dev --no-audit --no-fund --legacy-peer-deps
            (pm2 describe kqp-control-fe >/dev/null 2>&1 || pm2 start npm --name 'kqp-control-fe' -- start)
            pm2 restart kqp-control-fe
          "

      - name: Cleanup key
        if: always()
        run: rm -f deploy_key

  package_offline:
    name: Package Offline Bundle (npm) and Upload to Server
    needs: build-and-deploy
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (full history not required)
        uses: actions/checkout@v4

      - name: Set up Node 20.12.2
        uses: actions/setup-node@v4
        with:
          node-version: "20.12.2"
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Prepare repo-local npm cache
        run: mkdir -p .offline-cache/npm

      - name: Install deps into local cache & (re)build
        env:
          npm_config_cache: ${{ github.workspace }}/.offline-cache/npm
          NEXT_TELEMETRY_DISABLED: "1"
        run: |
          set -euo pipefail
          npm install --legacy-peer-deps
          npx --yes next telemetry disable || true
          npm run build
          test -d .next || (echo ".next not found after build" && exit 1)

      # Create a stable snapshot to avoid 'file changed as we read it'
      - name: Stage a clean snapshot for tar
        run: |
          set -euo pipefail
          rm -rf .offline-stage
          mkdir -p .offline-stage
          rsync -a --delete \
            --exclude ".git" \
            --exclude ".github" \
            --exclude ".offline-stage" \
            --exclude "*.tar.gz" \
            --exclude "node_modules" \
            ./ .offline-stage/

          # include the offline npm cache inside the snapshot
          mkdir -p .offline-stage/.offline-cache
          rsync -a .offline-cache/npm .offline-stage/.offline-cache/

      - name: Create offline tarball (snapshot + npm cache)
        run: |
          set -euo pipefail
          TAR="kqp-control-fe-offline-npm.tar.gz"
          echo "Creating $TAR from .offline-stage ..."
          tar -C .offline-stage -czf "$TAR" .
          ls -lh "$TAR"

      - name: Upload tarball as workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: kqp-control-fe-offline-npm
          path: kqp-control-fe-offline-npm.tar.gz
          if-no-files-found: error

      - name: Upload tarball to deployment server
        env:
          DEPLOY_SERVER: ${{ secrets.DEPLOY_SERVER }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }} # same private key
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          set -euo pipefail
          echo "$DEPLOY_KEY" > deploy_key
          chmod 600 deploy_key

          TAR="kqp-control-fe-offline-npm.tar.gz"
          DATE="$(date -u +'%Y-%m-%dT%H-%M-%SZ')"
          SHA="${GITHUB_SHA::7}"
          REMOTE_DIR="$DEPLOY_PATH/offline/${DATE}-${SHA}"

          ssh -i deploy_key -o StrictHostKeyChecking=no "$DEPLOY_USER@$DEPLOY_SERVER" "mkdir -p '$REMOTE_DIR' '$DEPLOY_PATH/offline/latest'"
          scp -i deploy_key -o StrictHostKeyChecking=no "$TAR" "$DEPLOY_USER@$DEPLOY_SERVER:$REMOTE_DIR/"

          # Point a stable symlink to the newest tar for convenience
          ssh -i deploy_key -o StrictHostKeyChecking=no "$DEPLOY_USER@$DEPLOY_SERVER" "
            ln -sfn '$REMOTE_DIR/$TAR' '$DEPLOY_PATH/offline/latest/kqp-control-fe-offline-npm.tar.gz'
          "

      - name: Cleanup key
        if: always()
        run: rm -f deploy_key
